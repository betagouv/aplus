@import scala.collection.immutable.ListMap
@(user: User, area: Area)(weeks: ListMap[String, String], allApplications: Map[Area, Seq[Application]], users: List[User])(implicit webJarsUtil: org.webjars.play.WebJarsUtil, flash: Flash)

@main(user, area)(s"Stats")  {
    <style xmlns="http://www.w3.org/1999/html">
        td {
            cursor: pointer;
        }
        #search-input {
            font-size: 17px;
            padding: 5px;
        }
        .usefulness__icon {
            width: 20px;
            height: 20px;
            vertical-align: middle;
        }
        .mdl-data-table th {
            white-space: initial !important;
        }
        .chart-container {
            position: relative;
            margin: auto;
            height: 50vh;
            width: 100%;
        }
    </style>
    @webJarsUtil.locate("Chart.bundle.min.js").script()
}{
    <div class="mdl-cell mdl-cell--12-col mdl-grid--no-spacing">
        <h4 class="mdl-cell mdl-cell--12-col">Demandes par territoire</h4>
        <div class="mdl-cell mdl-cell--12-col mdl-grid mdl-grid--no-spacing pem-container">
        @defining(allApplications.flatMap(_._2).flatMap(_.administrations(users)).toSet.toList) { admins =>
            <table class="mdl-data-table mdl-js-data-table pem-table mdl-shadow--2dp mdl-cell mdl-cell--12-col " style="white-space: normal;">
                <thead>
                    <tr>
                        <th class="mdl-data-table__cell--non-numeric">Territoire</th>
                        <th>Total</th>
                        <th>Total clôturé</th>
                        <th>Total Non Pertinante</th>
                    </tr>
                </thead>
                <tfoot class="invisible">
                    <tr>                                           
                        <td class="mdl-data-table__cell--non-numeric" colspan="5" style="text-align: center"><button class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored" onclick="clearSearch()">
                            Supprimer le filtre et afficher toutes les demandes</button></td>
                    </tr>
                </tfoot>
                <tbody>
                    @for((area, applications) <- allApplications) {
                        <tr class="application-row">
                            <td class="mdl-data-table__cell--non-numeric">@area.name</td>
                            <td>@applications.length</td>
                            <td>@applications.count(_.closed)</td>
                            <td>@applications.count(_.irrelevant)</td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        </div>
        @for((area, applications) <- allApplications) {
            <h4 class="mdl-cell mdl-cell--12-col">@area.name</h4>
            @defining(weeks.keys.toSeq.map{ week:String => week -> applications.filter(a => a.estimatedClosedDate.isDefined && f"${a.estimatedClosedDate.get.getYear}/${a.estimatedClosedDate.get.getWeekOfWeekyear}%02d" == week) }) { closedApplicationsPerWeek: Seq[(String, Seq[Application])] =>

            @defining(weeks.keys.toSeq.map{ week:String => week -> applications.filter(a => f"${a.creationDate.getYear}/${a.creationDate.getWeekOfWeekyear}%02d" == week) } ) { newApplicationsPerWeek: Seq[(String, Seq[Application])] =>
                <div class="mdl-cell mdl-cell--12-col mdl-shadow--2dp mdl-color--white mdl-grid">
                    <canvas class="mdl-cell mdl-cell--12-col" id="application-chart-@area.name" style="height: 300px"></canvas>
                    <script>
                        new Chart(document.getElementById('application-chart-@area.name'), {
                            // The type of chart we want to create
                            type: 'bar',

                            // The data for our dataset
                            data: {
                                labels: [@Html(newApplicationsPerWeek.map(_._1).flatMap(weeks.get).map(day => s"'$day'").mkString(", "))],
                                datasets: [{
                                    label: "Nouvelles demandes",
                                    backgroundColor: '#3f51b5',
                                    borderColor: '#3f51b5',
                                    stack: 'new',
                                    data: [@Html(newApplicationsPerWeek.map(_._2.length).mkString(", "))]
                                }, {
                                    label: "Demandes clôturées non évalué",
                                    backgroundColor: 'gray',
                                    borderColor: 'gray',
                                    stack: 'useful',
                                    data: [@Html(closedApplicationsPerWeek.map(_._2.count(_.usefulness.isEmpty)).mkString(", "))],
                                },{
                                    label: "Demandes clôturées non utiles",
                                    backgroundColor: 'orange',
                                    borderColor: 'orange',
                                    stack: 'useful',
                                    data: [@Html(closedApplicationsPerWeek.map(_._2.count(_.usefulness.contains("Non"))).mkString(", "))],
                                }, {
                                    label: "Demandes clôturées utilité inconnue",
                                    backgroundColor: 'yellow',
                                    borderColor: 'yellow',
                                    stack: 'useful',
                                    data: [@Html(closedApplicationsPerWeek.map(_._2.count(_.usefulness.contains("Je ne sais pas"))).mkString(", "))],
                                },{
                                    label: "Demandes clôturées utiles",
                                    backgroundColor: 'green',
                                    borderColor: 'green',
                                    stack: 'useful',
                                    data: [@Html(closedApplicationsPerWeek.map(_._2.count(_.usefulness.contains("Oui"))).mkString(", "))]
                                }, {
                                    label: "Demandes clôturées non pertinentes",
                                    backgroundColor: 'red',
                                    borderColor: 'red',
                                    stack: 'irrelevant',
                                    data: [@Html(closedApplicationsPerWeek.map(_._2.count(_.irrelevant)).mkString(", "))]
                                }]
                            },

                            // Configuration options go here
                            options: {
                                tooltips: {
                                    mode: 'index',
                                    intersect: false
                                },
                                responsive: true,
                                scales: {
                                    xAxes: [{
                                        stacked: true,
                                    }],
                                    yAxes: [{
                                        stacked: true,
                                        ticks: {"beginAtZero":true, fixedStepSize: 1}
                                    }]
                                }
                            }
                        });
                    </script>
                    <details class="mdl-cell mdl-cell--12-col">
                        <summary>Détail des demandes reçues par les agents d'administrations </summary>

                        @defining(newApplicationsPerWeek.flatMap(_._2).flatMap(_.administrations(users)).toSet.toList) { admins =>
                            <div class="chart-container">
                                <canvas id="admin-received-chart-@area.name"></canvas>
                            </div>
                            <script>
                                    var adminReceivedColors = ["#caff70","#caff70","#8b8970","#8b8970","#a2cd5a","#a2cd5a","#eea2ad","#eea2ad","#666666","#666666","#7a7a7a","#7a7a7a","#87ceff","#87ceff","#6ca6cd","#6ca6cd","#eedd82","#eedd82","#ee6a50","#ee6a50","#ee7942","#ee7942","#ff83fa","#ff83fa","#c9c9c9","#c9c9c9","#919191","#919191","#cd5c5c","#cd5c5c","#454545","#454545","#eee9bf","#eee9bf",];
                                    new Chart(document.getElementById('admin-received-chart-@area.name'), {
                                        // The type of chart we want to create
                                        type: 'line',
                                        // The data for our dataset
                                        data: {
                                            labels: [@Html(newApplicationsPerWeek.map(_._1).flatMap(weeks.get).map(day => s"'$day'").mkString(", "))],
                                            datasets: [
                                                @for(admin: String <- admins) {
                                                {
                                                    label: "@Html(admin)",
                                                    fill: false,
                                                    borderColor: adminReceivedColors.pop(),
                                                    backgroundColor: adminReceivedColors.pop(),
                                                    lineTension: 0,
                                                    data: [@Html(newApplicationsPerWeek.map(_._2.count(_.administrations(users).contains(admin))).mkString(", "))]
                                                },
                                                }
                                            ]
                                        },

                                        // Configuration options go here
                                        options: {
                                            maintainAspectRatio: false,
                                            "scales":{
                                                yAxes: [{
                                                    ticks: {"beginAtZero":true,fixedStepSize: 1}
                                                }]
                                            }
                                        }
                                    });
                            </script>
                            <table class="mdl-data-table mdl-js-data-table mdl-cell mdl-cell--12-col">
                                        <thead>
                                            <tr>
                                                <th class="mdl-data-table__cell--non-numeric">Semaine</th>
                                                <th>Nouvelle</th>
                                                @for(admin: String <- admins) {
                                                    <th>@admin</th>
                                                }
                                                </tr>
                                        </thead>
                                        <tbody>
                                        @for((week, applications) <- newApplicationsPerWeek.reverse) {
                                            <tr class="application-row">
                                                <td class="mdl-data-table__cell--non-numeric">@weeks(week) (@week)</td>
                                                <td>@applications.length</td>
                                                @for(admin: String <- admins) {
                                                    <td>@applications.count(_.administrations(users).contains(admin))</td>
                                                }
                                            </tr>
                                        }
                                        </tbody>

                            </table>
                        }
                    </details>
                    <details class="mdl-cell mdl-cell--12-col">
                        <summary>Détail des demandes faites par des structures aidantes</summary>
                        @defining(newApplicationsPerWeek.flatMap(_._2).flatMap(_.creatorUserQualite(users)).toSet.toList) { admins =>
                        <div class="chart-container">
                            <canvas id="helper-admin-chart-@area.name"></canvas>
                        </div>
                        <script>
                                var adminReceivedColors = ["#caff70","#caff70","#8b8970","#8b8970","#a2cd5a","#a2cd5a","#eea2ad","#eea2ad","#666666","#666666","#7a7a7a","#7a7a7a","#87ceff","#87ceff","#6ca6cd","#6ca6cd","#eedd82","#eedd82","#ee6a50","#ee6a50","#ee7942","#ee7942","#ff83fa","#ff83fa","#c9c9c9","#c9c9c9","#919191","#919191","#cd5c5c","#cd5c5c","#454545","#454545","#eee9bf","#eee9bf",];
                                new Chart(document.getElementById('helper-admin-chart-@area.name'), {
                                    // The type of chart we want to create
                                    type: 'line',
                                    // The data for our dataset
                                    data: {
                                        labels: [@Html(newApplicationsPerWeek.map(_._1).flatMap(weeks.get).map(day => s"'$day'").mkString(", "))],
                                        datasets: [
                                            @for(admin: String <- admins) {
                                            {
                                                label: "@Html(admin)",
                                                fill: false,
                                                lineTension: 0,
                                                borderColor: adminReceivedColors.pop(),
                                                backgroundColor: adminReceivedColors.pop(),
                                                data: [@Html(newApplicationsPerWeek.map(_._2.count(_.creatorUserQualite(users).contains(admin))).mkString(", "))]
                                            },
                                            }
                                        ]
                                    },

                                    // Configuration options go here
                                    options: {
                                        maintainAspectRatio: false,
                                        responsive: true,
                                        "scales":{
                                            yAxes: [{
                                                ticks: {"beginAtZero":true, fixedStepSize: 1}
                                            }]
                                        }
                                    }
                                });
                        </script>
                        <table class="mdl-data-table mdl-js-data-table mdl-cell mdl-cell--12-col">
                            <thead>
                                <tr>
                                    <th class="mdl-data-table__cell--non-numeric">Semaine</th>
                                    <th>Nouvelle</th>
                                    @for(admin: String <- admins) {
                                        <th>@admin</th>
                                    }
                                    </tr>
                            </thead>
                            <tbody>
                            @for((week, applications) <- newApplicationsPerWeek.reverse) {
                                <tr class="application-row">
                                    <td class="mdl-data-table__cell--non-numeric">@weeks(week) (@week)</td>
                                    <td>@applications.length</td>
                                    @for(admin: String <- admins) {
                                        <td>@applications.count(_.creatorUserQualite(users).contains(admin))</td>
                                    }
                                </tr>
                            }
                            </tbody>
                        </table>
                        }
                    </details>
                   <details class="mdl-cell mdl-cell--12-col">
                    <summary>Détail des demandes clôturées</summary>
                    <table class="mdl-data-table mdl-js-data-table mdl-cell mdl-cell--12-col">
                    <thead>
                        <tr>
                            <th class="mdl-data-table__cell--non-numeric">Semaine</th>
                            <th>Clôturé</th>
                            <th>Non Pertinante</th>
                            <th><img class="usefulness__icon" src="@webJarsUtil.locate("1f600.svg").url.get"> Oui</th>
                            <th><img class="usefulness__icon" src="@webJarsUtil.locate("1f610.svg").url.get"> Je ne sais pas</th>
                            <th><img class="usefulness__icon" src="@webJarsUtil.locate("1f61e.svg").url.get"> Non</th>
                            <th>?</th>
                            </tr>
                    </thead>
                    <tbody>
                    @for((week, applications) <- closedApplicationsPerWeek.reverse) {
                        <tr class="application-row">
                            <td class="mdl-data-table__cell--non-numeric">@weeks(week) (@week)</td>
                            <td>@applications.length</td>
                            <td style="color: red; font-weight: bold">@applications.count(_.irrelevant)</td>
                            <td>@applications.count(_.usefulness.contains("Oui")) <img class="usefulness__icon" src="@webJarsUtil.locate("1f600.svg").url.get"></td>
                            <td>@applications.count(_.usefulness.contains("Je ne sais pas")) <img class="usefulness__icon" src="@webJarsUtil.locate("1f610.svg").url.get"></td>
                            <td>@applications.count(_.usefulness.contains("Non")) <img class="usefulness__icon" src="@webJarsUtil.locate("1f61e.svg").url.get"></td>
                            <td>@applications.count(_.usefulness.isEmpty) ?</td>
                        </tr>
                    }
                    </tbody>
                    </table>
                   </details>
                </div>
            }
            }
        }
    </div>
}
