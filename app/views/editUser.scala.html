@import models._
@import extentions.MDLForms._
@import extentions.UUIDHelper._
@import extentions.BooleanHelper
@import java.util.UUID
@(currentUser: User)(form: Form[User], userId: UUID, areas: List[UUID], selectedGroups: List[UUID], userGroups: List[UserGroup], unused: Boolean = false, tokenName: String = "", tokenValue: String = "")(implicit webJarsUtil: org.webjars.play.WebJarsUtil, flash: Flash, messagesProvider: MessagesProvider, request: RequestHeader)

@main(currentUser)(s"Utilisateur ${form("name").value.getOrElse("")}") {
    <link rel="stylesheet" media="screen,print" href='@routes.Assets.versioned("stylesheets/newForm.css")'>
    <script src='@routes.Assets.versioned("javascripts/dialog.js")'></script>
    @webJarsUtil.locate("slimselect.min.css").css()
    @webJarsUtil.locate("slimselect.min.js").script()
}{
    @helper.form(action = routes.UserController.editUserPost(userId), 'class -> "mdl-grid mdl-cell mdl-cell--12-col") {
        @for(user <- form.value) {
            @for((area, group) <- user.areas.headOption.flatMap(Area.fromId).zip(user.groupIds.headOption.flatMap(groupId => userGroups.find(_.id == groupId)))) {
                <span class="mdl-cell mdl-cell--12-col ariane">
                    Territoire : <a href="@routes.UserController.all(user.areas.head)#group-@user.groupIds.head">@{area.name}</a> /
                    Groupe : <a href="@routes.GroupController.editGroup(group.id)">@{group.name}</a> /
                    Utilisateur : @form("name").value.getOrElse("") </span>
            }
        }
    <div class="mdl-cell mdl-cell--12-col">
        <button class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-cell">
            Sauvegarder
        </button>
    </div>
    <div class="mdl-cell mdl-cell--6-col-desktop mdl-cell--12-col">
    @helper.CSRF.formField

    @if(form.hasGlobalErrors) {
      <div style="color: red; font-weight: bold;">@form.globalErrors.mkString(", ")</div>
    }
    @helper.input(form("id"), 'label -> "Id", 'class -> "hidden") { (id, name, value, args) =>
        <input class="mdl-textfield__input" type="text" name="@name" id="@id" value="@value" @toHtmlArgs(args)>
    }
    @helper.input(form("name"), 'label -> "Nom et prénom") { (id, name, value, args) =>
    <input class="mdl-textfield__input" type="text" name="@name" id="@id" value="@value" @toHtmlArgs(args)>
    } <br>
    @helper.input(form("qualite"), 'label -> "Qualité") { (id, name, value, args) =>
    <input class="mdl-textfield__input" type="text" name="@name" id="@id" value="@value" @toHtmlArgs(args)>
    } <br>
    @helper.input(form(csv.USER_PHONE_NUMBER.key), 'label -> "Numéro de téléphone") { (id, name, value, args) =>
       <input class="mdl-textfield__input" type="text" name="@name" id="@id" value="@value" @toHtmlArgs(args)>
     } <br>
    @helper.input(form("communeCode"), 'label -> "Code INSEE commune") { (id, name, value, args) =>
    <input class="mdl-textfield__input" type="text" name="@name" id="@id" value="@value" @toHtmlArgs(args) disabled>
    } <br>
    @helper.input(form("email"), 'label -> "Email") { (id, name, value, args) =>
    <input class="mdl-textfield__input" type="text" name="@name" id="@id" value="@value" @toHtmlArgs(args)>
    }
    @helper.checkbox(form("instructor"), 'type -> "checkbox", 'label -> "Instructeur", 'class -> "mdl-checkbox__input")
    @helper.checkbox(form("helper"), 'type -> "checkbox", 'label -> "Aidant", 'class -> "mdl-checkbox__input")
    @helper.checkbox(form("adminGroup"), 'type -> "checkbox", 'label -> "Responsable de ces groupes", 'class -> "mdl-checkbox__input")
    @helper.checkbox(form("disabled"), 'type -> "checkbox", 'label -> "Désactiver l'utilisateur", 'class -> "mdl-checkbox__input")

    @if(unused) {
      <button class="mdl-button mdl-js-button mdl-button--raised" type="button" onclick="showDialog(document.querySelector('#dialog-delete-user'))">Supprimer cet utilisateur inutilisé.</button>
      <br>
    }
    <br>
    <b style="color: red">@helper.checkbox(form("admin"), 'type -> "checkbox", 'label -> "Admin de la zone", 'class -> "mdl-checkbox__input")</b>
  </div>
    <div class="mdl-cell mdl-cell--6-col-desktop mdl-cell--12-col mdl-grid">
        <b class="mdl-cell mdl-cell--12-col">Sélectionner des territoires</b>
        <select id="area-ids" name="areas[]" multiple>
            @helper.repeat(form("areas")) { userField =>
                <option value="@userField.value" selected>@{userField.value.flatMap(uuid => fromString(uuid).flatMap(Area.fromId)).map(_.name)}</option>
            }
            @for(area <- Area.all) {
                @if(BooleanHelper.not(areas.contains(area.id))) {
                    <option value="@area.id">@area.name</option>
                }
            }
        </select>
        <b class="mdl-cell mdl-cell--12-col">Sélectionner les groupes</b>
        <select id="multiple" name="groupIds[]" multiple>
            @helper.repeat(form("areas")) { areaField =>
                @defining(areaField.value.flatMap(id => fromString(id).flatMap(Area.fromId)).get) { area =>
                    <optgroup label="@{area.name}">
                        @helper.repeat(form("groupIds")) { groupField =>
                            @defining(groupField.value.flatMap(groupId => userGroups.find(_.id.toString == groupId))) { group =>
                                @if(group.map(_.areaIds.contains(area.id)).getOrElse(false)) {
                                    <option value="@groupField.value" selected>@{group.map(_.name)}</option>
                                }
                            }
                        }
                        @for(userGroup <- userGroups.filter(group => group.areaIds.contains(area.id)).filterNot(group => form.data.values.toList.contains(group.id))) {
                            <option value="@userGroup.id">@userGroup.name</option>
                        }
                    </optgroup>
                }
            }
        </select>
        <script>
            new SlimSelect({ select: '#area-ids' });
            new SlimSelect({ select: '#multiple' });
        </script>
        @if(form("areas").hasErrors) {
            <p style="color: red; font-weight: bold;">@form("areas").errors.map(_.format).mkString(", ")</p>
        }
    </div>
    <div class="mdl-cell mdl-cell--12-col">
        <button class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-cell">
            Sauvegarder
        </button>
    </div>
    <div class="mdl-color--white mdl-shadow--2dp mdl-cell mdl-cell--12-col">
        <b>Outils</b>
        <p>
            <a href="@routes.ApplicationController.allAs(userId)">Aperçu de l'écran de toutes les demandes de l'utilisateur</a><br>
            <a href="@routes.UserController.allEvents()?fromUserId=@userId">Log d'événements de l'utilisateur</a>
        </p>
    </div>
    }
    <script type='text/javascript'>
        function showHide(sender) {
            var thead = sender.parentNode.parentNode.parentNode.parentNode;
            var tbody = thead.nextElementSibling;
            if(sender.checked) {
                tbody.classList.remove("invisible");
            } else {
                tbody.classList.add("invisible");
            }
        }
    </script>

    <dialog class="mdl-dialog" id="dialog-delete-user">
        <h4 class="mdl-dialog__title">Suppression d'un utilisateur inutilisé.</h4>
        <div class="mdl-dialog__content">
            <b>Êtes-vous certain de vouloir supprimer le compte de cet utilisateur?</b>
        </div>
        <div class="mdl-dialog__actions">
            <button type="button" class="mdl-button mdl-button--raised mdl-button--colored" onclick="confirmDeletion()">Confirmer</button>
            <button type="button" class="mdl-button mdl-button--raised" onclick="closeDialog(document.querySelector('#dialog-delete-user'))">Annuler</button>
        </div>
    </dialog>

    <script type="text/javascript">
        var dialog = document.querySelector('#dialog-delete-user');
        if (!dialog.showModal) {
            dialogPolyfill.registerDialog(dialog);
        }

        function confirmDeletion() {
            document.location = '@routes.UserController.deleteUnusedUserById(userId)';
        }
    </script>
}