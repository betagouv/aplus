@import models._
@import _root_.helper.MDLForms._

@(currentUser: User, currentUserRights: Authorization.UserRights, currentArea: Area)(instructorsOfGroups: List[User], organisationGroups: List[UserGroup], coworkers: List[User], userSignature: Option[String], applicationForm: Form[models.formModels.ApplicationFormData], attachments: Iterable[String] = Nil)(implicit webJarsUtil: org.webjars.play.WebJarsUtil, flash: Flash, request: RequestHeader, messagesProvider: MessagesProvider)

@main(currentUser, currentUserRights, Some(currentArea))(s"Nouvelle demande")  {
    <link rel="stylesheet" media="screen,print" href='@routes.Assets.versioned("stylesheets/newForm.css")'>
    <style>
    .mdl-data-table td {
        padding: 0px 18px;
    }
    </style>
}{
        <div class="mdl-cell mdl-cell--12-col">
            <div style="margin-bottom: 20px"><a href="@routes.ApplicationController.myApplications()">Mes demandes</a> <span style="margin: 0 10px 0 10px"> > </span> Nouvelle Demande</div>
            <div class="mdl-grid mdl-grid--no-spacing">
                <h4 class="mdl-cell mdl-cell--8-col mdl-cell--12-col-phone">Nouvelle demande</h4>
                <a class="mdl-button mdl-js-button mdl-button--raised mdl-button--primary mdl-cell mdl-cell--4-col mdl-cell--12-col-phone" href="@routes.ApplicationController.createSimplified()">
                    Mode Guidé
                </a>
            </div>
            Besoin d'aide ? Contactez-nous sur <a href="mailto:@Constants.supportEmail?subject=Aidez-moi%20avec%20Administration+">@Constants.supportEmail</a>

            @helper.form(action = routes.ApplicationController.createPost(), 'onsubmit -> "addInfo();", 'enctype -> "multipart/form-data", 'id -> "create-application-form", 'class -> "aplus-protected-form") {
                @helper.CSRF.formField
                    <input type="hidden" name="application-id" readonly value="@applicationForm("application-id").value.getOrElse(java.util.UUID.randomUUID)">
                    <h5 class="title--addline">Sélectionnez les organismes concernés sur la zone @currentArea.name</h5>

                    <div class="mdl-grid mdl-grid--no-spacing">
                        @if(applicationForm("users").hasErrors) {
                            <p style="color: red; font-weight: bold;">@applicationForm("users").errors.map(_.format).mkString(", ")</p>
                        }
                        
                        <table class="mdl-data-table mdl-js-data-table mdl-cell mdl-cell--12-col" id="users">
                        @for(organisationGroup <- organisationGroups.sortBy(_.name)) {
                            @defining(organisationGroup.organisationSetOrDeducted) { organisation: Option[Organisation] =>
                                <thead>
                                    <tr>
                                        <th class="mdl-data-table__cell--non-numeric" colspan="2">
                                            <label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect mdl-js-ripple-effect--ignore-events">
                                                <input type="checkbox" class="mdl-checkbox__input" onclick="showHideUsers(this);" value="@organisationGroup.name" name="organismes[]" @if(applicationForm.data.find({case (k, v) => k.startsWith("organismes[") && v == organisationGroup.name})){ checked="checked" }>
                                                <span class="mdl-checkbox__label">@organisationGroup.name @if(organisation.nonEmpty){ (@organisation.get.name) }</span>
                                                <span id="span-group-description">@organisationGroup.description</span>
                                            </label></th>
                                    </tr>
                                </thead>
                                <tbody class="organisation-row @if(!applicationForm.data.find({case (k, v) => k.startsWith("organismes[") && v == organisationGroup.name})){ invisible }">
                                    @if(organisation.map(_.shortName).contains("CAF")) {
                                        <tr><td colspan="2" style="text-align: left; white-space: normal">
                                            <div class="info-box info-box--no-spacing">La CAF aura besoin du <b>numéro identifiant CAF</b> et à défaut de la date de naissance. Vous pouvez le renseigner dans <b>Informations concernant l'usager</b> ci-dessous.</div>
                                        </td></tr>
                                    } else if(organisation.map(_.shortName).contains("CPAM")) {
                                    <tr><td colspan="2" style="text-align: left; white-space: normal">
                                        <div class="info-box info-box--no-spacing">La CPAM aura besoin du <b>numéro de sécurité sociale</b> et à défaut de la date de naissance. Vous pouvez le renseigner dans <b>Informations concernant l'usager</b> ci-dessous.</div>
                                    </td></tr>
                                    }

                                    @for(instructor <- instructorsOfGroups.filter(_.groupIds.contains(organisationGroup.id))) {
                                        <tr class="invisible" >
                                            <td style="width: 95px">
                                                <i class="material-icons" style="vertical-align: middle;">chevron_right</i>
                                                <label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect mdl-js-ripple-effect--ignore-events">
                                                    <input type="checkbox" class="mdl-checkbox__input" name="users[]" value="@instructor.id" @if(applicationForm.data.find({case (k, v) => k.startsWith("users[") && v == instructor.id.toString})){ checked="checked" }>
                                                </label>
                                            </td>
                                            <td class="mdl-data-table__cell--non-numeric">@instructor.name</td>
                                        </tr>
                                    }
                                </tbody>
                            }
                        }
                        </table>
                    </div>
                    <br>
                    <h5 class="title--addline">Sujet</h5>
                     @helper.input(applicationForm("subject"), 'label -> "Saisir le sujet de votre demande...", 'class -> "mdl-textfield--large") { (id, name, value, args) =>
                        <input class="mdl-textfield__input" type="text" name="@name" id="@id" value="@value" @toHtmlArgs(args)>
                    }
                    <br>


                    <h5 class="title--addline">Informations concernant l'usager</h5>
                    @helpers.usersInformations(applicationForm, List("Prénom", "Nom de famille", "Date de naissance"))
                    <br>
                    <br>
                    <h5 class="title--addline">Description du problème</h5>

                    <div>
                        @helper.input(applicationForm("description"), 'class -> "mdl-textfield--floating-label mdl-textfield--large", 'label -> "Rédigez une description rapide du problème ...") { (id, name, value, args) =>
                            <textarea class="mdl-textfield__input textfield__input--no-height-constraint" type="text" rows= "5" name="@name" id="@id" @toHtmlArgs(args)>@value</textarea>
                        }<br>

                        @if(currentUser.sharedAccount) {
                            Signature :<br>
                            @helper.input(
                                applicationForm("signature"),
                                'label -> "Renseignez ici votre : Prénom, NOM, service",
                                'class -> "mdl-textfield--large"
                            ) { (id, name, value, args) =>
                                <input class="mdl-textfield__input"
                                       type="text"
                                       name="@name"
                                       id="@id"
                                       @if(currentUser.sharedAccount && value.isEmpty) {
                                           value="@{userSignature.getOrElse(value)}"
                                       } else {
                                           value="@value"
                                       }
                                       @toHtmlArgs(args)>
                            }<br>
                        }

                        @if(applicationForm("file").hasErrors) {
                            <span style="color: red; font-weight: bold;">@applicationForm("file").errors.map(_.format).mkString(", ")</span><br>
                        }
                        Ajouter un/des ficher(s) ( Facultatif, 5Mo maximum ) :
                        <ul>
                            @for((attachment,index) <- attachments.zipWithIndex) {
                                <li>@attachment</li>
                            }
                        </ul>
                        <ul id="attachment-list">
                            <li><input type="file" name="file[0]"></li>
                        </ul>
                    </div>  <br>


                    @if(coworkers.nonEmpty) {
                      <br>
                      <br>
                      <h5 class="title--addline">Ajouter des collègues à la demande</h5>
                      <table>
                      @for(coworker <- coworkers) {
                        <tr>
                          <td>
                            <label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect mdl-js-ripple-effect--ignore-events">
                              <input type="checkbox" class="mdl-checkbox__input" name="users[]" value="@coworker.id" @if(applicationForm.data.find({case (k, v) => k.startsWith("users[") && v == coworker.id.toString})){ checked="checked" }>
                            </label>
                          </td>
                          <td class="mdl-data-table__cell--non-numeric">@coworker.name</td>
                        </tr>
                      }
                      </table>
                    }


                    <div style="margin-top: 60px; margin-bottom: 50px;">
                        <label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect" for="checkbox-mandat" style="height: unset; margin-bottom: 10px;">
                            <input type="checkbox" id="checkbox-mandat" name="validate" class="mdl-checkbox__input" value="true">
                            <span class="mdl-checkbox__label">Je confirme que l'usager m'a donné mandat pour effectuer cette demande.</span>
                        </label> <br>
                        <button id="review-validation" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored" disabled>
                            Envoyer ma demande
                        </button>
                    </div>
            }
        </div>
}{
        <script src="@routes.Assets.versioned("javascripts/application-attachment.js")"></script>
        <script type="text/javascript">
         function showHideUsers(sender) {
             var thead = sender.parentNode.parentNode.parentNode.parentNode;
             var tbody = thead.nextElementSibling;
             var inputs = tbody.querySelectorAll("[type=checkbox]");
             if(sender.checked) {
                 for(var i = 0; i < inputs.length; i++){
                     var input = inputs[i];
                     input.checked = true;
                     input.parentNode.classList.add("is-checked");
                     componentHandler.upgradeElements(input);
                 }
                 tbody.classList.remove("invisible");
             } else {
                 for(var i = 0; i < inputs.length; i++){
                     var input = inputs[i];
                     input.checked = false;
                     input.parentNode.classList.remove("is-checked");
                     componentHandler.upgradeElements(input);
                 }
                 tbody.classList.add("invisible");
             }

         }
         var checkbox = document.querySelector("#checkbox-mandat");

         checkbox.addEventListener('click', function() {
             if(checkbox.checked) {
                 document.querySelector("#review-validation").disabled = false;
             } else {
                 document.querySelector("#review-validation").disabled = true;
             }
         });
        </script>
}
