@import scala.collection.immutable.ListMap
@import java.util.UUID

@import _root_.helper.{Math, Time}
@(isAdmin: Boolean)(data: views.stats.StatsData, months: ListMap[String, String], users: List[User])(implicit webJarsUtil: org.webjars.play.WebJarsUtil)


<div class="mdl-cell mdl-cell--12-col">
    <br>
    <span>Dernière mise à jour : @{Time.formatPatternFr(Time.nowParis(), "dd MMM YYYY - HH:mm:ss")}</span>
</div>

<!-- New Stats -->
<div class="mdl-cell mdl-cell--6-col mdl-shadow--2dp mdl-color--white typography--text-align-center">
    <h6>Total de demandes</h6>
    <h1>@data.all.count</h1>
    <h5>@data.all.countLast30Days sur les 30 derniers jours</h5>
</div>
<div class="mdl-cell mdl-cell--6-col mdl-shadow--2dp mdl-color--white typography--text-align-center">
    <h6>Total d'utilisateurs</h6>
    <h1>@users.length</h1>
    <h5>@users.count(_.ageInDays <= 30) sur les 30 derniers jours</h5>
</div>
<div class="mdl-cell mdl-cell--6-col mdl-shadow--2dp mdl-color--white typography--text-align-center">
    <h6>Répartition des demandes</h6>
    @applicationsStatusPieChart(data)
    <h5>@data.allApplications.count(a => a.ageInDays <= 30 && a.closed) clôturé sur les 30 derniers jours</h5>
</div>
<div class="mdl-cell mdl-cell--6-col mdl-shadow--2dp mdl-color--white typography--text-align-center">
    <h6>Pertinences des demandes</h6>
    @applicationsRelevantPieChart(data)
    <h5>@data.allApplications.count(a => a.ageInDays <= 30 && a.irrelevant) non pertinente sur les 30 derniers jours</h5>
</div>

<div class="mdl-cell mdl-cell--12-col mdl-shadow--2dp mdl-color--white typography--text-align-center">
    <h6>Est-ce que la réponse vous semble utile pour l'usager ?</h6>
    @applicationsUsefulnessFeedbackBarChart(data)
</div>

<div class="mdl-cell mdl-cell--12-col mdl-shadow--2dp mdl-color--white typography--text-align-center">
    <h6>Temps de résolution</h6>
    @applicationsResolutionTimeBarChart(data)
</div>

<div class="mdl-cell mdl-cell--12-col mdl-shadow--2dp mdl-color--white typography--text-align-center">
    <h6>Demandes déposés</h6>
    @newApplicationsLineChart(data)
</div>
<div class="mdl-cell mdl-cell--12-col mdl-shadow--2dp mdl-color--white typography--text-align-center">
    <h6>Demandes clôturé</h6>
    @closedApplicationsLineChart(data)
</div>

@if(isAdmin) {
    <div class="mdl-cell mdl-cell--12-col mdl-shadow--2dp mdl-color--white typography--text-align-center">
        <h6>Demande par administration réceptrice (Beta)</h6>
        @applicationsByAdministrationPieChart(data, users)
    </div>
}

@if(isAdmin) {
    <!-- all -->
    <div class="mdl-cell mdl-cell--12-col mdl-grid--no-spacing mdl-shadow--2dp mdl-color--white">
        <h6>Demandes par territoire</h6>
        <div class="mdl-cell mdl-cell--12-col mdl-grid">
            @applicationsByAreaTable(data, users)
        </div>
    </div>

    <!-- Old Stats -->
    <div class="mdl-cell mdl-cell--12-col mdl-grid--no-spacing">
        @for(areaData <- data.aggregatesByArea) {
            <h4 class="mdl-cell mdl-cell--12-col">@areaData.area.name</h4>
            <div class="mdl-cell mdl-cell--12-col mdl-shadow--2dp mdl-color--white mdl-grid">
                @stats.oneAreasClosedApplicationsBarChart(areaData, months)
                <details class="mdl-cell mdl-cell--12-col">
                    <summary>Détail des demandes reçues par les instructeurs d'administrations </summary>

                    @defining(areaData.aggregates.newApplicationsPerMonth.flatMap(_._2).flatMap(_.administrations(users)).toSet.toList) { admins =>

                    <div class="chart-container">
                        @oneAreasApplicationsByAdministrationLineChart(areaData, months, users, admins)
                    </div>
                    @oneAreasApplicationsByAdministrationTable(areaData, months, users, admins)

                    }
                </details>

                <details class="mdl-cell mdl-cell--12-col">
                    <summary>Détail des demandes faites par des structures aidantes</summary>
                    @defining(areaData.aggregates.newApplicationsPerMonth.flatMap(_._2).flatMap(_.creatorUserQualite(users)).toSet.toList) { admins =>

                    <div class="chart-container">
                        @oneAreasApplicationsByCreatorQualiteLineChart(areaData, months, users, admins)
                    </div>
                    @oneAreasApplicationsByCreatorQualiteTable(areaData, months, users, admins)

                    }
                </details>
                <details class="mdl-cell mdl-cell--12-col">
                    <summary>Détail des demandes clôturées</summary>
                    @oneAreasClosedApplicationsTable(areaData, months)
                </details>
            </div>
        }
    </div>
}
