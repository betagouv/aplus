@(user: User, area: Area)(applicationsCreatedByMe: Seq[Application], applicationsIGotInvited: Seq[Application], applicationsFromTheArea: Seq[Application] = List())(implicit webJarsUtil: org.webjars.play.WebJarsUtil, flash: Flash)
@import java.util.Locale

@main(user, area)(s"Toutes les demandes")  {
<style>
    .pem-table {
        width: 100%;
    }
    td {
        cursor: pointer;
    }
    #search-input {
        font-size: 17px;
        padding: 5px;
    }
    .usefulness__icon {
        width: 20px;
        height: 20px;
        vertical-align: middle;
    }
</style>
<script>
    var extract = 9;
    function onSearch() {
        var searchTerm = document.getElementById("search-input").value.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, "");
        if(searchTerm.length > 2) {
            Array.from(document.querySelectorAll("tfoot")).forEach(function (app) { app.classList.remove("invisible") });
            Array.from(document.querySelectorAll(".application-row")).forEach(function (app) {
                if (searchTerm.length > 2) {
                    var searchData = app.getAttribute("data-search");
                    var searchResult = searchData.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, "").indexOf(searchTerm);
                    if(searchResult !== -1) {
                        app.classList.remove("invisible");
                        var minIndex = Math.max(searchResult - extract, 0);
                        var maxIndex = Math.min(searchResult + searchTerm.length + extract, searchData.length);
                        app.querySelector(".search-cell").innerHTML = searchData.substring(minIndex, searchResult) +
                                '<span style="font-weight: bold; background-color: #FFFF00;">'+searchData.substring(searchResult, searchResult + searchTerm.length)+
                                "</span>"+searchData.substring(searchResult + searchTerm.length, maxIndex);
                    } else {
                        app.classList.add("invisible");
                        app.querySelector(".search-cell").innerHTML = "";
                    }
                }
            });
        } else {
            Array.from(document.querySelectorAll(".application-row")).forEach(function (app) { app.classList.remove("invisible"); });
            Array.from(document.querySelectorAll(".search-cell")).forEach(function (cell) { cell.innerHTML=""; });
            Array.from(document.querySelectorAll("tfoot")).forEach(function (app) { app.classList.add("invisible") });
        }
    }

    function clearSearch() {
        document.getElementById("search-input").value = "";
        onSearch();
    }
</script>
}{
    @if(applicationsCreatedByMe.isEmpty && applicationsIGotInvited.isEmpty && applicationsFromTheArea.isEmpty) {
        <div class="mdl-cell mdl-cell--12-col mdl-grid--no-spacing">
            <p>Vous n'avez pas de demande en cours.
            @if(user.helper) {
                Vous pouvez en créer une nouvelle en cliquant ici : <a href="@routes.ApplicationController.create()">Créer une nouvelle demande</a>
            }
            </p>
        </div>

    } else {
        <input class="mdl-cell mdl-cell--12-col" type="search" placeholder="Filtrer les demandes (saisir nom, numéro, description, etc)" id="search-input" onsearch="onSearch()" oninput="onSearch()"/><br>
        @if(applicationsCreatedByMe.nonEmpty) {
            <div class="mdl-cell mdl-cell--12-col mdl-grid--no-spacing">
                <h4 class="mdl-cell mdl-cell--12-col">Les demandes que j'ai créées</h4>
                <div class="mdl-cell mdl-cell--12-col pem-container">
                    <table class="mdl-data-table mdl-js-data-table pem-table mdl-shadow--2dp" style="white-space: normal;">
                        <thead>
                            <tr>
                                <th class="mdl-data-table__cell--non-numeric">Date</th>
                                <th class="mdl-data-table__cell--non-numeric">Sujet</th>
                                <th class="mdl-data-table__cell--non-numeric">Avancement</th>
                                <th class="mdl-data-table__cell--non-numeric"></th>
                            </tr>
                        </thead>
                        <tfoot class="invisible">
                            <tr>
                                <td class="mdl-data-table__cell--non-numeric" colspan="4" style="text-align: center"><button class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored" onclick="clearSearch()">Supprimer le filtre et afficher toutes les demandes</button></td>
                            </tr>
                        </tfoot>
                        <tbody>
                        @for((application) <- applicationsCreatedByMe.sortBy(_.closed)) {
                            <tr onclick="window.document.location = '@routes.ApplicationController.show(application.id)';" data-search="@application.searchData" class="application-row">
                                <td class="mdl-data-table__cell--non-numeric">@application.creationDate.toString("dd MMM YYYY - HH:mm", new Locale("fr")) @if(application.closed == false) { (@application.ageString) }</td>
                                <td class="mdl-data-table__cell--non-numeric">@application.subject</td>
                                <td class="mdl-data-table__cell--non-numeric" @if(application.closed == false) { style="font-weight: bold" }>@application.status(user)</td>
                                <td class="mdl-data-table__cell--non-numeric search-cell"></td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
            </div>
        }

        @if(applicationsIGotInvited.nonEmpty) {
            <div class="mdl-cell mdl-cell--12-col mdl-grid--no-spacing">
                <h4 class="mdl-cell mdl-cell--12-col">Demandes sur lesquelles j'ai été invité</h4>
                <div class="mdl-cell mdl-cell--12-col pem-container">
                    <table class="mdl-data-table mdl-js-data-table pem-table mdl-shadow--2dp" style="white-space: normal;">
                        <thead>
                            <tr>
                                <th class="mdl-data-table__cell--non-numeric">Date</th>
                                <th class="mdl-data-table__cell--non-numeric">Sujet</th>
                                <th class="mdl-data-table__cell--non-numeric">Avancement</th>
                                <th class="mdl-data-table__cell--non-numeric"></th>
                            </tr>
                        </thead>
                        <tfoot class="invisible">
                            <tr>
                                <td class="mdl-data-table__cell--non-numeric" colspan="4" style="text-align: center"><button class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored" onclick="clearSearch()">Supprimer le filtre et afficher toutes les demandes</button></td>
                            </tr>
                        </tfoot>
                        <tbody>
                        @for((application) <- applicationsIGotInvited.sortBy(_.closed)) {
                            <tr onclick="window.document.location = '@routes.ApplicationController.show(application.id)';" data-search="@application.searchData" class="application-row @if(application.isLateForUser(user)){ application-row--late } else { @if(application.isNearlyLateForUser(user)){ application-row--nearly-late }  }">
                                <td class="mdl-data-table__cell--non-numeric">@application.creationDate.toString("dd MMM YYYY - HH:mm", new Locale("fr")) @if(application.closed == false) { (@application.ageString) }</td>
                                <td class="mdl-data-table__cell--non-numeric">@application.subject</td>
                                <td class="mdl-data-table__cell--non-numeric" @if(application.closed == false) { style="font-weight: bold" }>@application.status(user)</td>
                                <td class="mdl-data-table__cell--non-numeric search-cell"></td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
            </div>
        }
    }
    @if(applicationsFromTheArea.nonEmpty && user.admin) {
        <div class="mdl-cell mdl-cell--12-col mdl-grid--no-spacing">
            <h4 class="mdl-cell mdl-cell--12-col">Toutes les demandes du territoire: @area.name</h4>
            <div class="mdl-cell mdl-cell--12-col pem-container">
                <table class="mdl-data-table mdl-js-data-table pem-table mdl-shadow--2dp" style="white-space: normal;">
                    <thead>
                        <tr>
                            <th class="mdl-data-table__cell--non-numeric"></th>
                            <th class="mdl-data-table__cell--non-numeric">Date</th>
                            <th class="mdl-data-table__cell--non-numeric">Sujet</th>
                            <th class="mdl-data-table__cell--non-numeric">Avancement</th>
                            <th class="mdl-data-table__cell--non-numeric">Créateur</th>
                            <th class="mdl-data-table__cell--non-numeric">Invités</th>
                            <th class="mdl-data-table__cell--non-numeric">Réponses</th>
                            <th class="mdl-data-table__cell--non-numeric">Utile</th>
                            <th class="mdl-data-table__cell--non-numeric">Non pertinente</th>
                            <th class="mdl-data-table__cell--non-numeric"></th>
                        </tr>
                    </thead>
                    <tfoot class="invisible">
                        <tr>
                            <td class="mdl-data-table__cell--non-numeric" colspan="7" style="text-align: center"><button class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored" onclick="clearSearch()">Supprimer le filtre et afficher toutes les demandes</button></td>
                        </tr>
                    </tfoot>
                    <tbody>
                    @for((application) <- applicationsFromTheArea) {
                        <tr onclick="window.document.location='@routes.ApplicationController.show(application.id)';" data-search="@application.searchData" class="application-row">
                            <td class="mdl-data-table__cell--non-numeric" style="font-weight: bold; color: red;">@application.internalId</td>
                            <td class="mdl-data-table__cell--non-numeric">@application.creationDate.toString("dd MMM YYYY - HH:mm", new Locale("fr"))</td>
                            <td class="mdl-data-table__cell--non-numeric">@application.subject</td>
                            <td class="mdl-data-table__cell--non-numeric" @if(application.closed == false) { style="font-weight: bold" }>@application.status(user)</td>
                            <td class="mdl-data-table__cell--non-numeric">@application.creatorUserName</td>
                            <td class="mdl-data-table__cell--non-numeric">@application.invitedUsers.size</td>
                            <td class="mdl-data-table__cell--non-numeric">@application.answers.length</td>
                            <td class="mdl-data-table__cell--non-numeric"><b>@application.usefulness match {
                                case Some("Oui") => {<img class="usefulness__icon" src="@webJarsUtil.url("1f600.svg").get"> Oui}
                                case Some("Je ne sais pas") => {<img class="usefulness__icon" src="@webJarsUtil.url("1f610.svg").get"> Je ne sais pas}
                                case Some("Non") => {<img class="usefulness__icon" src="@webJarsUtil.url("1f61e.svg").get"> Non}
                                case None => { ? }
                            }</b></td>
                            <td class="mdl-data-table__cell--non-numeric">@if(application.irrelevant) { <span style="color: red; font-weight: bold;">Oui</span> } else { Non } </td>
                            <td class="mdl-data-table__cell--non-numeric search-cell"></td>
                        </tr>
                    }
                    </tbody>
                </table>
            </div>
        </div>
    }
    <button class="mdl-button mdl-js-button mdl-button--raised mdl-cell mdl-cell--8-col mdl-cell--2-offset" onclick="document.location='@routes.ApplicationController.allCSV()'">
        Télécharger CSV
    </button>
}
