apiVersion: v1
kind: Service
metadata:
  name: aplus-app
  labels:
    app: aplus
spec:
  # Note: this is the default type = ClusterIP
  ports:
  - port: 9000
    targetPort: 9000
  selector:     # Should be a Pod selector
    app: aplus
    tier: frontend
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: aplus-files-pvc
  labels:
    app: aplus
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
  storageClassName: csi-cinder-classic
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: aplus-app-deployment
  labels:
    app: aplus
spec:
  replicas: 1
  selector:       # Should match .spec.template
    matchLabels:
      app: aplus
      tier: frontend
  strategy:
    type: Recreate  # here RollingUpdate is not well handled by app sql queries
  template:
    metadata:
      labels:
        app: aplus
        tier: frontend
    spec:
      containers:
      - image: betagouv/aplus:0.16.1
        name: aplus-app
        env:
        - name: APP_HOST
          valueFrom:
            configMapKeyRef:
              name: aplus-config
              key: APP_HOST
        - name: APP_HTTPS
          value: "true"
        - name: APPLICATION_SECRET
          valueFrom:
            secretKeyRef:
              name: aplus-application-secret
              key: APPLICATION_SECRET
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: aplus-db-app-secret
              key: DATABASE_URL
        - name: EVOLUTIONS_AUTOAPPLY
          value: "true"
        - name: FEATURE_AUTO_ADD_EXPERT
          valueFrom:
            configMapKeyRef:
              name: aplus-config
              key: FEATURE_AUTO_ADD_EXPERT
        - name: FEATURE_SEND_APPLICATIONS_ANYWHERE
          value: "true"
        - name: FEATURE_SMS_MANDAT
          value: "true"
        - name: FEATURE_WEEKLY_EMAILS
          valueFrom:
            configMapKeyRef:
              name: aplus-config
              key: FEATURE_WEEKLY_EMAILS
        - name: FILES_EXPIRATION_IN_DAYS
          value: "15"

        - name: FILES_PATH
          value: "/app/files"
        - name: GROUPS_WHICH_CANNOT_HAVE_INSTRUCTORS
          value: "f32d20bf-a201-4875-9c69-16a5a4ad2f9c,ecb83438-b78b-4fbc-b0cd-880ce55562df"
        - name: MAIL_HOST
          valueFrom:
            secretKeyRef:
              name: aplus-email-secret
              key: MAIL_HOST
        - name: MAIL_PASSWORD
          valueFrom:
            secretKeyRef:
              name: aplus-email-secret
              key: MAIL_PASSWORD
        - name: MAIL_PORT
          valueFrom:
            secretKeyRef:
              name: aplus-email-secret
              key: MAIL_PORT
        - name: MAIL_SSL
          value: "yes"
        - name: MAIL_USER
          valueFrom:
            secretKeyRef:
              name: aplus-email-secret
              key: MAIL_USER
        - name: NOTIFICATION_EMAIL_BLACKLIST
          value: "daniel.balmy@beta.gouv.fr"

        - name: OVH_APPLICATION_KEY
          valueFrom:
            secretKeyRef:
              name: aplus-ovh-sms-secret
              key: OVH_APPLICATION_KEY
        - name: OVH_APPLICATION_SECRET
          valueFrom:
            secretKeyRef:
              name: aplus-ovh-sms-secret
              key: OVH_APPLICATION_SECRET
        - name: OVH_CONSUMER_KEY
          valueFrom:
            secretKeyRef:
              name: aplus-ovh-sms-secret
              key: OVH_CONSUMER_KEY
        - name: OVH_SERVICE_NAME
          valueFrom:
            secretKeyRef:
              name: aplus-ovh-sms-secret
              key: OVH_SERVICE_NAME

        - name: PERSONAL_DATA_RETENTION_IN_MONTHS
          valueFrom:
            configMapKeyRef:
              name: aplus-config
              key: PERSONAL_DATA_RETENTION_IN_MONTHS

        - name: SENTRY_DSN
          valueFrom:
            secretKeyRef:
              name: aplus-sentry-secret
              key: SENTRY_DSN
        - name: SENTRY_TRACES_SAMPLE_RATE
          value: "0.01"

        - name: SMS_USE_LIVE_API
          value: "true"
        - name: WEEKLY_EMAILS_DAY_OF_WEEK
          value: tuesday
        - name: WEEKLY_EMAILS_HOUR_OF_DAY
          value: "10"
        - name: WEEKLY_EMAILS_MAX_NUMBER
          value: "1000"

        ports:
        - containerPort: 9000
        volumeMounts:
        - name: aplus-files-pv
          mountPath: /app/files
      volumes:
      - name: aplus-files-pv
        persistentVolumeClaim:
          claimName: aplus-files-pvc
